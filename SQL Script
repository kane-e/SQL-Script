
-- Find percent rank for each firm for each metric category

SELECT B.*,
    ROUND((PERCENT_RANK() OVER(PARTITION BY FIRMSIZE ORDER BY ACTVN)) *100 , 0) AS ACTVN_PERC,
    ROUND((PERCENT_RANK() OVER(PARTITION BY FIRMSIZE ORDER BY FILES)) *100 , 0) AS FILES_PERC,
    ROUND((PERCENT_RANK() OVER(PARTITION BY FIRMSIZE ORDER BY MESSAGES)) *100 , 0) AS MESSAGES_PERC,
    ROUND((PERCENT_RANK() OVER(PARTITION BY FIRMSIZE ORDER BY TASKS)) *100 , 0) AS TASKS_PERC,
    ROUND((PERCENT_RANK() OVER(PARTITION BY FIRMSIZE ORDER BY TASKS)) *100 , 0) AS APPS_PERC
FROM METRICSJULY3 B
WHERE FIRMNAME LIKE 'Test Account One'



-- Find combined metrics from last two weeks for each firm 
SELECT * FROM (SELECT DISTINCT A.FIRM_NAME AS FIRMNAME,
                 (CASE WHEN ROUND(((A.EMPLOYEE_COUNT + B.EMPLOYEE_COUNT)/2), 0) BETWEEN 0 AND 4 THEN 'small' WHEN ROUND(((A.EMPLOYEE_COUNT + B.EMPLOYEE_COUNT)/2), 0) BETWEEN 5 AND 10 THEN 'medium' ELSE 'large' END) AS FIRMSIZE,
                ROUND(((A.PCT_ACTIVE + B.PCT_ACTIVE)/2), 0) AS ACTVN,
                (A.FILES_UPLOADED_TOTAL + B.FILES_UPLOADED_TOTAL) AS FILES,
                (A.TOTAL_MESSAGES + B.TOTAL_MESSAGES) AS MESSAGES,
                (A.CLIENT_USAGE + B.CLIENT_USAGE) AS TASKS,
                (A.EMPLOYEE_USAGE + B.EMPLOYEE_USAGE) AS APPS      
FROM METRICS2 A , METRICS2 B
WHERE A.ID <> B.ID
AND A.FIRM_NAME = B.FIRM_NAME) 

